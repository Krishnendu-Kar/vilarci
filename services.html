<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Services - Vilarci</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Smooth fade-in for new items */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 h-16 flex items-center justify-between px-4 lg:px-8 shadow-sm">
        <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="bg-indigo-600 text-white font-bold text-xl px-2 py-1 rounded">V</div>
            <span class="text-2xl font-extrabold text-indigo-900 tracking-tight">Vilarci</span>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="menu-btn" class="lg:hidden p-2 text-slate-500 hover:text-indigo-600 transition">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </nav>

    <div class="flex max-w-[1600px] mx-auto w-full flex-grow relative">
        
        <aside id="sidebar" class="hidden lg:block w-64 bg-white border-r border-slate-200 flex-shrink-0 h-[calc(100vh-64px)] sticky top-16 overflow-y-auto transition-transform duration-300 z-40">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h2 class="font-bold text-slate-900">Explore Categories</h2>
                <button id="close-sidebar" class="lg:hidden text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div id="sidebar-container">
                <div class="p-4 space-y-4 animate-pulse">
                    <div class="h-4 bg-slate-100 rounded w-3/4"></div>
                    <div class="h-4 bg-slate-100 rounded w-1/2"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 min-w-0">
            
            <div class="mb-6">
                <span class="text-xs font-bold text-indigo-600 uppercase tracking-wide">Home Services</span>
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mt-1">Recently Added</h1>
            </div>

            <div id="services-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>

            <div id="loading-trigger" class="py-12 flex justify-center w-full">
                <div id="spinner" class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-100 border-t-indigo-600"></div>
                <p id="end-message" class="hidden text-slate-400 text-sm font-medium">You've reached the end.</p>
            </div>
        </main>
    </div>

    <script src="service_sidebar.js"></script>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dmNndWJicXRjY295Y3ZkdXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODA2MzQsImV4cCI6MjA4MDA1NjYzNH0.7Hobx-emspJQ7HLyjaWR-XQhzk948LWufq3OCimKk4w'; 
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Initialize Sidebar (Reusable Component)
        initSidebar(supabaseClient, 'sidebar-container');
        lucide.createIcons();

        // ==========================================
        // 2. INFINITE SCROLL STATE
        // ==========================================
        let loadedCount = 0;
        let isLoading = false;
        let allLoaded = false;
        
        // Specific Logic: 25 first, then 14 thereafter
        const INITIAL_BATCH = 25;
        const NEXT_BATCH = 14;

        // ==========================================
        // 3. FETCH LOGIC
        // ==========================================
        async function loadServices() {
            if (isLoading || allLoaded) return;
            isLoading = true;

            const isFirstLoad = loadedCount === 0;
            const limit = isFirstLoad ? INITIAL_BATCH : NEXT_BATCH;
            const from = loadedCount;
            const to = from + limit - 1;

            console.log(`Loading items ${from} to ${to}...`);

            // Secure Database Query
            const { data, error } = await supabaseClient
                .from('services')
                .select('name, slug, price, normal_price, image_url, badge_label, duration_minutes')
                .eq('is_active', true)
                .range(from, to)
                .order('id', { ascending: false }); // Newest first

            if (error) {
                console.error("Fetch Error:", error);
                isLoading = false;
                return;
            }

            // Check if we reached the end
            if (!data || data.length === 0) {
                allLoaded = true;
                stopLoadingUI();
                return;
            }

            renderCards(data);
            loadedCount += data.length;
            isLoading = false;

            // If fewer items returned than requested, we are at the end
            if (data.length < limit) {
                allLoaded = true;
                stopLoadingUI();
            }
        }

        // ==========================================
        // 4. RENDER LOGIC
        // ==========================================
        function renderCards(services) {
            const grid = document.getElementById('services-grid');

            services.forEach(svc => {
                const card = document.createElement('div');
                card.className = "bg-white border border-slate-200 rounded-xl overflow-hidden hover:shadow-lg transition cursor-pointer fade-in flex flex-col h-full group";
                card.onclick = () => window.location.href = `service_details.html?slug=${svc.slug}`;

                // Image Fallback
                const imgUrl = svc.image_url || 'https://placehold.co/600x400?text=Vilarci';
                
                // Price Logic
                let priceHtml = `<span class="text-lg font-bold text-slate-900">₹${svc.price}</span>`;
                if (svc.normal_price && svc.normal_price > svc.price) {
                    priceHtml += `<span class="ml-2 text-sm text-slate-400 line-through">₹${svc.normal_price}</span>`;
                }

                // Badge Logic
                const badge = svc.badge_label 
                    ? `<span class="absolute top-2 left-2 bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow">${escapeHtml(svc.badge_label)}</span>` 
                    : '';

                card.innerHTML = `
                    <div class="relative aspect-[4/3] bg-slate-100 overflow-hidden">
                        <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        ${badge}
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-bold text-slate-900 mb-1 line-clamp-1 text-lg">${escapeHtml(svc.name)}</h3>
                        <div class="flex items-center gap-2 text-xs text-slate-500 mb-4 font-medium">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${svc.duration_minutes || 60} mins
                        </div>
                        <div class="mt-auto flex items-center justify-between pt-2 border-t border-slate-50">
                            <div class="flex items-baseline">${priceHtml}</div>
                            <button class="bg-indigo-50 text-indigo-600 p-2 rounded-lg hover:bg-indigo-600 hover:text-white transition">
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // Re-init icons for new elements
            lucide.createIcons();
        }

        function stopLoadingUI() {
            document.getElementById('spinner').classList.add('hidden');
            document.getElementById('end-message').classList.remove('hidden');
        }

        // Helper to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.innerText = text;
            return div.innerHTML;
        }

        // ==========================================
        // 5. OBSERVER & MOBILE MENU
        // ==========================================
        
        // Infinite Scroll Observer
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadServices();
            }
        }, { rootMargin: '100px' });
        
        observer.observe(document.getElementById('loading-trigger'));

        // Mobile Sidebar Logic
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeBtn = document.getElementById('close-sidebar');

        function toggleMobileMenu() {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('w-full');
            // Prevent body scroll when menu is open
            document.body.classList.toggle('overflow-hidden');
        }

        menuBtn.onclick = toggleMobileMenu;
        closeBtn.onclick = toggleMobileMenu;

    </script>
</body>
</html>