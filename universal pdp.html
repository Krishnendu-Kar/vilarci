<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-600">Vilarci</h1>
            <a href="#" class="text-gray-500 hover:text-gray-900">Back to Search</a>
        </div>
    </nav>

    <!-- LOADING STATE -->
    <div id="loader" class="flex items-center justify-center h-[80vh]">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>

    <!-- ERROR STATE -->
    <div id="error-screen" class="hidden flex flex-col items-center justify-center h-[80vh] text-center">
        <i data-lucide="alert-circle" class="w-16 h-16 text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-800">Product Not Found</h2>
        <p class="text-gray-500 mt-2">The product ID provided is invalid or does not exist.</p>
    </div>

    <!-- MAIN PRODUCT CONTAINER -->
    <main id="product-container" class="hidden max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            
            <!-- LEFT: IMAGE GALLERY -->
            <div class="space-y-4">
                <div class="aspect-square bg-white rounded-2xl overflow-hidden border border-gray-200 shadow-sm relative">
                    <!-- Badge -->
                    <span id="badge-label" class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full hidden">
                        SALE
                    </span>
                    <img id="main-image" src="" alt="Product" class="w-full h-full object-contain p-4 hover:scale-105 transition-transform duration-300">
                </div>
                <!-- Thumbnails would go here -->
            </div>

            <!-- RIGHT: DETAILS -->
            <div class="space-y-6">
                
                <!-- Breadcrumbs & IDs -->
                <div class="flex justify-between items-start">
                    <div class="text-xs text-gray-500 font-mono space-y-1">
                        <p>ID: <span id="display-id" class="text-gray-800">...</span></p>
                        <p>Seller: <span id="display-seller" class="text-gray-800">...</span></p>
                    </div>
                    <!-- Rating Placeholder -->
                    <div class="flex items-center bg-green-50 px-2 py-1 rounded text-green-700 text-sm font-bold">
                        <span>4.5</span> <i data-lucide="star" class="w-3 h-3 ml-1 fill-current"></i>
                    </div>
                </div>

                <!-- Title & Price -->
                <div>
                    <h1 id="product-title" class="text-3xl font-bold text-gray-900 leading-tight">...</h1>
                    <div class="mt-2 flex items-baseline gap-3">
                        <span id="price-display" class="text-4xl font-bold text-gray-900">₹0</span>
                        <span id="mrp-display" class="text-lg text-gray-400 line-through">₹0</span>
                        <span id="discount-display" class="text-sm font-bold text-green-600"></span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" id="tax-note">Inclusive of all taxes</p>
                </div>

                <hr class="border-gray-100">

                <!-- DYNAMIC CATEGORY SECTION (The Magic Part) -->
                <!-- This div fills up differently based on Category 12 vs 14 -->
                <div id="dynamic-logic-container"></div>

                <!-- DESCRIPTION -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm uppercase">Description</h3>
                    <p id="product-description" class="text-gray-600 text-sm leading-relaxed">...</p>
                </div>

                <!-- HIGHLIGHTS -->
                <div id="specs-container">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm uppercase">Highlights</h3>
                    <div id="product-hightlights" class="grid grid-cols-2 gap-y-2 text-sm">
                        <!-- JS injects rows here -->
                    </div>
                </div> 

                <!-- SPECIFICATIONS -->
                <div id="specs-container">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm uppercase">Specifications</h3>
                    <div id="specs-grid" class="grid grid-cols-2 gap-y-2 text-sm">
                        <!-- JS injects rows here -->
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 md:static md:bg-transparent md:border-0 md:p-0 flex gap-4 z-40">
                    <button class="flex-1 bg-white border-2 border-indigo-600 text-indigo-700 font-bold py-3 rounded-xl hover:bg-indigo-50 transition">
                        Add to Cart
                    </button>
                    <button class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                        Buy Now
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_wy4_pxxwFkS63SSL_d5yug_Bgybs85R';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Icon initializer
        lucide.createIcons();

        // ==========================================
        // 2. MAIN INIT LOGIC
        // ==========================================
        
        async function initPage() {
            // 1. Get ID from URL (e.g., ?id=1010011200100012345)
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showError();
                return;
            }

            // 2. Fetch from Supabase (Real-time connection)
            // Note: In Supabase, 'id' is BigInt, so we compare it as a string is safer in JS or number
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .eq('id', productId) // Supabase handles the BigInt query
                .single();

            if (error || !data) {
                console.error(error);
                showError();
                return;
            }

            // 3. Render The Page
            renderUniversalData(data);
            
            // 4. DETECT CATEGORY Logic (Digits 6 & 7)
            // String: 101001[12]001...
            // Index:  012345[67]...
            const idString = productId.toString();
            const categoryCode = idString.substring(6, 8); // Extracts characters at index 6 and 7

            console.log("Detected Category Code:", categoryCode);

            if (categoryCode === '12') {
                renderFashionLogic(data);
            } else if (categoryCode === '14') {
                renderGroceryLogic(data);
            } else {
                // Fallback for unknown categories
                renderStandardLogic(data);
            }

            document.getElementById('loader').classList.add('hidden');
            document.getElementById('product-container').classList.remove('hidden');
        }

        // ==========================================
        // 3. RENDERERS
        // ==========================================

        function renderUniversalData(product) {
            // Basic Fields
            document.getElementById('display-id').innerText = product.id;
            document.getElementById('display-seller').innerText = product.seller_id;
            document.getElementById('product-title').innerText = product.name;
            document.getElementById('product-description').innerText = product.description || "No description available.";
            
            // Images
            if (product.images && product.images.length > 0) {
                document.getElementById('main-image').src = product.images[0];
            } else {
                document.getElementById('main-image').src = "https://via.placeholder.com/400?text=No+Image";
            }

            // Badge
            if (product.badge_label) {
                const badge = document.getElementById('badge-label');
                badge.innerText = product.badge_label;
                badge.classList.remove('hidden');
            }
            // Highlights
            const highlightsContainer = document.getElementById('product-hightlights');
            if (product.highlights) {
                product.highlights.forEach(point => {
                    const div = document.createElement('div');
                    div.className = "text-gray-700";
                    div.innerText = `• ${point}`;
                    highlightsContainer.appendChild(div);
                });
            }

            
            // Specifications (Common to all)
            const specsGrid = document.getElementById('specs-grid');
            if (product.specifications) {
                Object.entries(product.specifications).forEach(([section, details]) => {
                    // Flattening nested objects for simple display
                    if(typeof details === 'object') {
                        Object.entries(details).forEach(([key, val]) => {
                            specsGrid.innerHTML += `
                                <div class="text-gray-500">${key}</div>
                                <div class="font-medium text-gray-900">${val}</div>
                            `;
                        });
                    } else {
                         specsGrid.innerHTML += `
                                <div class="text-gray-500">${section}</div>
                                <div class="font-medium text-gray-900">${details}</div>
                            `;
                    }
                });
            }

            // Initial Price Render (Base Price)
            updatePriceUI(product.base_price, product.original_price);
        }

        // --- LOGIC A: FASHION (Category 12) ---
        function renderFashionLogic(product) {
            const container = document.getElementById('dynamic-logic-container');
            const variants = product.variants;

            if (!variants || variants.length === 0) {
                container.innerHTML = `<p class="text-red-500 text-sm">Out of Stock</p>`;
                return;
            }

            let html = `
                <div class="space-y-3">
                    <h3 class="font-bold text-gray-800 text-sm uppercase">Select Size</h3>
                    <div class="flex flex-wrap gap-2" id="variant-buttons">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            `;
            container.innerHTML = html;

            const btnContainer = document.getElementById('variant-buttons');
            
            variants.forEach((v, index) => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 border-2 rounded-lg font-bold text-sm transition-all ${index === 0 ? 'border-indigo-600 text-indigo-700 bg-indigo-50' : 'border-gray-200 text-gray-600 hover:border-gray-300'}`;
                btn.innerText = v.size;
                
                // Logic: Click updates Price
                btn.onclick = () => {
                    // Reset styling
                    Array.from(btnContainer.children).forEach(b => b.className = 'px-4 py-2 border-2 rounded-lg font-bold text-sm transition-all border-gray-200 text-gray-600 hover:border-gray-300');
                    // Active styling
                    btn.className = 'px-4 py-2 border-2 rounded-lg font-bold text-sm transition-all border-indigo-600 text-indigo-700 bg-indigo-50';
                    
                    // Update Price UI based on this specific variant
                    updatePriceUI(v.price, product.original_price);
                };
                btnContainer.appendChild(btn);
            });

            // Set initial price to first variant
            updatePriceUI(variants[0].price, product.original_price);
        }

        // --- LOGIC B: GROCERY (Category 14) ---
        function renderGroceryLogic(product) {
            const container = document.getElementById('dynamic-logic-container');
            const bulkRules = product.bulk_rules;

            let html = `
                <div class="space-y-3">
                    <h3 class="font-bold text-gray-800 text-sm uppercase">Bulk Quantity Offers</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-yellow-800 uppercase border-b border-yellow-200">
                                <tr>
                                    <th class="pb-2">Quantity</th>
                                    <th class="pb-2 text-right">Savings</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
            `;

            if (bulkRules) {
                bulkRules.forEach(rule => {
                    html += `
                        <tr class="border-b border-yellow-100 last:border-0">
                            <td class="py-2">Buy ${rule.min_qty} ${rule.unit || 'units'} +</td>
                            <td class="py-2 text-right font-bold text-green-600">Save ₹${rule.discount_amount || rule.discount}</td>
                        </tr>
                    `;
                });
            } else {
                html += `<tr><td colspan="2" class="py-2 text-center text-gray-400">No bulk offers available</td></tr>`;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                    <!-- Weight Selector (Simple Input for Grocery) -->
                     <div class="flex items-center gap-2 mt-4">
                        <label class="text-sm font-bold text-gray-700">Quantity:</label>
                        <div class="flex items-center border rounded-lg bg-white">
                            <button class="px-3 py-1 text-gray-500 hover:bg-gray-100">-</button>
                            <input type="text" value="1" class="w-12 text-center text-sm font-bold focus:outline-none">
                            <button class="px-3 py-1 text-gray-500 hover:bg-gray-100">+</button>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // --- FALLBACK LOGIC ---
        function renderStandardLogic(product) {
             const container = document.getElementById('dynamic-logic-container');
             // Just show stock
             container.innerHTML = `
                <div class="inline-block bg-gray-100 px-3 py-1 rounded text-sm text-gray-600">
                    Stock Available: <span class="font-bold text-gray-900">${product.stock_quantity}</span>
                </div>
             `;
        }

        // --- UTILS ---
        function updatePriceUI(price, mrp) {
            document.getElementById('price-display').innerText = `₹${price}`;
            
            if (mrp && mrp > price) {
                document.getElementById('mrp-display').innerText = `₹${mrp}`;
                const discount = Math.round(((mrp - price) / mrp) * 100);
                document.getElementById('discount-display').innerText = `${discount}% OFF`;
            } else {
                document.getElementById('mrp-display').innerText = '';
                document.getElementById('discount-display').innerText = '';
            }
        }

        function showError() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
        }

        // Start
        initPage();

    </script>
</body>
</html>