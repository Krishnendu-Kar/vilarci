<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile - Vilarci</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>body { font-family: 'Inter', sans-serif; }
    /* Navigation Search Styles */
    .nav-search {
        height: 37px;
        max-width: 700px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        border-radius: 7px;
        border: 1px solid #e2e8f0;
        background-color: #fff;
        flex: 1 1 auto;
        min-width: 0; 
    }

    .search-input {
        height: 100%;
        font-size: 1rem;
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
        border: none;
        padding-left: 12px;
        outline: none;
        width: 100%;
        min-width: 0; 
    }

    .search-icon {
        height: 100%;
        width: 45px;
        display: flex;
        background: linear-gradient(90deg, #ffffff, #fdacd7);
        justify-content: center;
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
        align-items: center;
        cursor: pointer;
    }

    @media (max-width: 554px){
        .nav-search{ margin-right: 0; max-width: 520px; }
    }
    @media (max-width: 345px){
        .nav-search{ margin-right: 0; max-width: 320px; }
    }

    .cart-wrapper {
        flex: 0 0 48px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
    }

    #cart-count-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: #fff;
        font-size: 0.7rem;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        font-weight: 700;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        z-index: 10;
    }

    .search-icon i { color: #d70675; }

    .discount-percent {
        display:flex;
        z-index: 20;
        position:absolute;
        right: 0px;
        background-color:rgb(0, 21, 255);
        font-size:12px;
        padding: 4px 4px 6px 8px;
        color:rgb(246, 246, 244);
        border: 1px solid rgb(113, 4, 150);
        border-top-right-radius: 5.5px;
        clip-path: polygon(
            0 0, 100% 0, 100% 80%, 
            95% 100%, 85% 80%, 75% 100%, 
            65% 80%, 55% 100%, 45% 80%, 
            35% 100%, 25% 80%, 15% 100%, 
            5% 80%, 0 100%
        );        
    } 
    .product-name{ color:#64748b !important; }
    .rating_avg{
        font-size: 0.85rem;
        background-color:#1b9d76;
        color:white;
        padding: 1px 6px;
        border-radius: 6px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 2px;
    }
    .rating_count{
        font-size: 0.8rem;
        font-weight: 500;
        color: #64748b;
        margin-left: 4px;
    }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer shrink-0" onclick="window.location.href='index.html'">
                <div class="bg-indigo-600 text-white font-bold text-xl px-2 py-1 rounded">V</div>
                <h1 class="hidden sm:block text-xl font-bold text-indigo-900">Vilarci</h1>
            </div>

            <div class="nav-search search-wrapper w-full max-w-md mx-auto">
                <input type="search" class="search-input search-boxAni" id="productSearch" onclick="window.location.href='universal search.html'" placeholder="Search...">
                <div class="search-icon" onclick="window.location.href='universal search.html'">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
            </div>

            <div class="cart-wrapper cursor-pointer" onclick="window.location.href='cart.html'">
                <i data-lucide="shopping-cart" class="w-6 h-6 text-slate-600"></i>
                <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
            </div>
        </div>
    </nav>

    <div id="loader" class="flex flex-col items-center justify-center h-[60vh]">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-slate-500 text-sm">Visiting Shop...</p>
    </div>

    <div id="error-screen" class="hidden flex flex-col items-center justify-center h-[60vh] text-center px-4">
        <div class="bg-slate-100 p-4 rounded-full mb-4">
            <i data-lucide="store-off" class="w-10 h-10 text-slate-400"></i>
        </div>
        <h2 class="text-xl font-bold text-slate-800" id="error-title">Shop Not Found</h2>
        <p class="text-slate-500 mt-2 mb-6" id="error-msg">The shop link might be incorrect or the seller has closed their store.</p>
        <a href="index.html" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">Back to Vilarci</a>
    </div>

    <div id="shop-container" class="hidden">
        
        <div class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:py-8">
                <div class="flex flex-row items-start gap-4">
                    
                    <div class="w-16 h-16 sm:w-20 sm:h-20 bg-indigo-50 rounded-2xl flex items-center justify-center border border-indigo-100 shadow-sm shrink-0">
                        <span class="text-2xl sm:text-3xl font-bold text-indigo-600" id="shop-initial">S</span>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h1 class="text-lg sm:text-2xl font-extrabold text-slate-900 truncate" id="shop-name">...</h1>
                            <span id="verified-badge" class="hidden" title="Verified Seller">
                                <i data-lucide="badge-check" class="w-5 h-5 text-blue-500 fill-blue-100"></i>
                            </span>
                        </div>

                        <div class="flex flex-wrap items-center text-xs sm:text-sm text-slate-500 mb-3 gap-y-1">
                            <span class="flex items-center gap-1 mr-3">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> 
                                <span id="shop-location">...</span>
                            </span>
                            <span class="text-slate-300 mr-3">|</span>
                            <span id="product-count" class="font-medium">0 Products</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 items-center">
                            <div class="flex items-center bg-green-50 px-2 py-1 rounded border border-green-100">
                                <span class="text-green-700 text-xs font-bold flex items-center gap-1">
                                    4.8 <i data-lucide="star" class="w-3 h-3 fill-current"></i>
                                </span>
                            </div>
                           
                            <span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs font-bold rounded border border-slate-200 truncate max-w-[120px]" id="shop-category">General Store</span>
                            
                            <div id="direction" class="hidden px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded border border-indigo-100 cursor-pointer hover:bg-indigo-100 transition items-center gap-1">
                                <i data-lucide="navigation" class="w-3 h-3"></i> 
                                <span class="hidden sm:inline">Direction</span>
                                <span class="sm:hidden">Map</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="shrink-0">
                        <button class="bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition shadow-md flex items-center justify-center p-3 sm:px-5 sm:py-2" title="Contact Seller">
                            <i data-lucide="message-circle" class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2"></i>
                            <span class="hidden sm:inline text-sm font-bold">Contact</span>
                        </button>
                    </div>

                </div>
            </div>
        </div>
        

        <main class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <h2 class="text-lg font-bold text-slate-800 shrink-0">All Products</h2>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto md:flex-1 md:justify-end">
                    <div class="relative flex-1 md:max-w-xs">
                        <input type="text" id="shop-search" placeholder="Search in this shop..." 
                            class="w-full pl-9 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition shadow-sm"
                            oninput="filterShopProducts(this.value)">
                        <div class="absolute left-3 top-2.5 text-slate-400">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <select id="sort-dropdown" onchange="sortProducts(this.value)" class="w-full sm:w-auto bg-white border border-slate-300 text-slate-700 text-sm rounded-lg px-3 py-2 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none shadow-sm cursor-pointer">
                        <option value="newest">Newest First</option>
                        <option value="low_high">Price: Low to High</option>
                        <option value="high_low">Price: High to Low</option>
                    </select>
                </div>
            </div>
            
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-6">
                </div>
            
            <div id="empty-products" class="hidden py-16 text-center bg-white rounded-2xl border border-dashed border-slate-300">
                <div class="inline-flex items-center justify-center w-14 h-14 bg-slate-50 rounded-full mb-3">
                    <i data-lucide="package-open" class="w-7 h-7 text-slate-400"></i>
                </div>
                <h3 class="text-base font-bold text-slate-700">No products found</h3>
                <p class="text-xs text-slate-500">Try adjusting your search or filters.</p>
            </div>
        </main>

    </div>

    <script>
        // --- Search Bar Animation Logic ---
        const searchInputBox = document.querySelector(".search-boxAni");
        const fullTexts = [" Search products...", " Search categories...", " Search offers..."];
        const shortTexts = [" Products...", " Categories...", " Offers..."];
        let texts = []; 
        let textIndex = 0;
        let charIndex = 0;
        let currentText = "";
        let typing = true;

        function updateTexts() {
            if (window.matchMedia("(max-width: 475px)").matches) {
                texts = shortTexts;
            } else {
                texts = fullTexts;
            }
        }

        function typeAnimation() {
            if (!searchInputBox) return;
            
            if (typing) {
                currentText = texts[textIndex].slice(0, ++charIndex);
                searchInputBox.setAttribute("placeholder", currentText);
                if (charIndex === texts[textIndex].length) {
                    typing = false;
                    setTimeout(typeAnimation, 1500); 
                    return;
                }
            } else {
                currentText = texts[textIndex].slice(0, --charIndex);
                searchInputBox.setAttribute("placeholder", currentText);
                if (charIndex === 0) {
                    typing = true;
                    textIndex = (textIndex + 1) % texts.length;
                }
            }
            setTimeout(typeAnimation, typing ? 70 : 60);
        }

        updateTexts();
        window.addEventListener("resize", updateTexts);
        typeAnimation();

        // CONFIGURATION
        const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dmNndWJicXRjY295Y3ZkdXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODA2MzQsImV4cCI6MjA4MDA1NjYzNH0.7Hobx-emspJQ7HLyjaWR-XQhzk948LWufq3OCimKk4w';
        
        // FIX: RENAMED TO supabaseClient TO PREVENT CRASH
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        lucide.createIcons();

        let allShopProducts = [];

        // INIT
        async function initShopPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');

            if (!slug) {
                showError("Invalid Link", "No shop ID was provided.");
                return;
            }

            console.log("Fetching seller:", slug);

            // FIX: Using supabaseClient
            const { data: seller, error } = await supabaseClient
                .from('shops_public_587') 
                .select('*') 
                .eq('shop_slug', slug)
                .single();

            if (error || !seller) {
                console.error("Error:", error);
                showError("Shop Unavailable", "This shop may be closed or the link is broken.");
                return;
            }

            renderShopHeader(seller);

            // FIX: Using supabaseClient
            const { data: products, error: prodError } = await supabaseClient
                .from('products')
                .select('*')
                .eq('seller_id', seller.seller_numeric_id)
                .eq('is_active', true)
                .order('created_at', { ascending: false });

            if (prodError) console.error("Prod Error:", prodError);
            
            allShopProducts = products || [];
            renderProductGrid(allShopProducts);
            updateCartCount();

            document.getElementById('loader').classList.add('hidden');
            document.getElementById('shop-container').classList.remove('hidden');
        }

        function renderShopHeader(seller) {
            document.getElementById('shop-name').innerText = seller.store_name;
            const initial = seller.shop_name ? seller.shop_name.charAt(0).toUpperCase() : 'S';
            document.getElementById('shop-initial').innerText = initial;
            
            // Logic: Pincode visible always
            document.getElementById('shop-location').innerText = `Pincode: ${seller.pincode}`;
            
            // Direction Button Logic
            const dirBtn = document.getElementById('direction');
            if (seller.direction && seller.direction.length > 0) {
                dirBtn.onclick = () => window.location.href = seller.direction;
                dirBtn.classList.remove('hidden');
                dirBtn.classList.add('flex');
            }

            if(seller.is_verified) {
                document.getElementById('verified-badge').classList.remove('hidden');
            }
        }

        function renderProductGrid(products) {
            document.getElementById('product-count').innerText = `${products.length} Products`;
            const grid = document.getElementById('products-grid');
            const empty = document.getElementById('empty-products');
            
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            empty.classList.add('hidden');

            grid.innerHTML = products.map(p => {
                const img = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/300?text=Vilarci';
                
                p.name = p.name.slice(0, 44) + (p.name.length > 44 ? "..." : "");

                let discountBadge = '';
                if (p.original_price && p.base_price < p.original_price) {
                    const off = Math.round(((p.original_price - p.base_price) / p.original_price) * 100);
                    discountBadge = `<span class="discount-percent">${off}% OFF</span>`;
                }

                return `
                <div onclick="window.location.href='product_details.html?slug=${p.slug}'" 
                     class="bg-white border border-slate-200 rounded-xl overflow-hidden cursor-pointer hover:shadow-lg transition-all duration-300 relative group">
                    ${discountBadge}
                    <div class="aspect-square bg-slate-50 flex items-center justify-center p-4 overflow-hidden">
                        <img src="${img}" class="w-full h-full object-contain mix-blend-multiply group-hover:scale-105 transition-transform duration-500" loading="lazy">
                    </div>
                    <div class="p-3">
                        <h3 class="product-name text-sm font-bold text-slate-800 leading-tight line-clamp-2 h-10 mb-1 ">${p.name}</h3>
                        
                        <div class="flex items-center mb-2">
                            <span class="rating_avg">
                                ${p.rating_avg || 4.5} <i class="fa-solid fa-star text-[0.6em]"></i>
                            </span>
                            <span class="rating_count">(${p.rating_count || 0})</span> 
                        </div>

                        <div class="flex items-baseline gap-1.5">
                            <span class="text-base font-bold text-slate-900">₹${p.base_price}</span>
                            ${p.original_price ? `<span class="text-xs text-slate-400 line-through">₹${p.original_price}</span>` : ''}
                        </div>
                        
                        <button onclick="addToCart(event, '${p.id}')" class="w-full mt-3 bg-indigo-50 border border-indigo-200 text-indigo-700 text-xs font-bold py-2 rounded-lg hover:bg-indigo-100 transition flex items-center justify-center gap-1">
                             Add <i class="fa-solid fa-cart-plus"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function filterShopProducts(query) {
            const lowerQ = query.toLowerCase();
            const filtered = allShopProducts.filter(p => p.name.toLowerCase().includes(lowerQ));
            const sortMode = document.getElementById('sort-dropdown').value;
            sortAndRender(filtered, sortMode);
        }

        function sortProducts(mode) {
            const query = document.getElementById('shop-search').value.toLowerCase();
            let list = allShopProducts.filter(p => p.name.toLowerCase().includes(query));
            sortAndRender(list, mode);
        }

        function sortAndRender(list, mode) {
            if (mode === 'low_high') list.sort((a, b) => a.base_price - b.base_price);
            else if (mode === 'high_low') list.sort((a, b) => b.base_price - a.base_price);
            else list.sort((a, b) => (a.created_at < b.created_at) ? 1 : -1);
            renderProductGrid(list);
        }

        function addToCart(event, id) {
            event.stopPropagation();
            const product = allShopProducts.find(p => String(p.id) === String(id));
            if (!product) return;

            const idString = String(product.id);
            if (idString.substring(6, 8) === '12') {
                Toastify({
                    text: "Please select a size first",
                    duration: 2000,
                    style: { background: "#3b82f6", borderRadius: "8px", fontSize: "12px" }
                }).showToast();
                setTimeout(() => window.location.href = `product_details.html?slug=${product.slug}`, 800);
                return; 
            }

            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItem = {
                id: product.id, slug: product.slug, name: product.name,
                price: product.base_price, originalPrice: product.original_price,
                amount: product.amount || "1 Unit",
                image: (product.images && product.images.length > 0) ? product.images[0] : "",
                quantity: 1, cartItemId: String(product.id)
            };

            const existingIndex = cart.findIndex(item => String(item.id) === String(id));
            if (existingIndex > -1) cart[existingIndex].quantity += 1;
            else cart.push(cartItem);

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            
            Toastify({
                text: "Added to Cart!",
                duration: 2000,
                style: { background: "#22c55e", borderRadius: "8px", fontSize: "12px" }
            }).showToast();
        }

        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let count = cart.reduce((acc, item) => acc + item.quantity, 0);
            const badge = document.getElementById('cart-count-badge');
            if(badge) badge.innerText = count;
        }

        function showError(title, msg) {
            document.getElementById('loader').classList.add('hidden');
            if(title) document.getElementById('error-title').innerText = title;
            if(msg) document.getElementById('error-msg').innerText = msg;
            document.getElementById('error-screen').classList.remove('hidden');
        }

        initShopPage();
    </script>
</body>
</html>