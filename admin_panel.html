<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vilarci Admin - Seller Approvals</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { font-family: sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <span class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xl">V</span>
                Admin Control Center
            </h1>
            <button onclick="loadSellers()" class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow hover:bg-gray-50 text-sm font-medium">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh Data
            </button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <p class="text-gray-500 text-xs uppercase font-bold">Pending Requests</p>
                <p class="text-3xl font-bold text-orange-600 mt-2" id="count-pending">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <p class="text-gray-500 text-xs uppercase font-bold">Total Sellers</p>
                <p class="text-3xl font-bold text-gray-800 mt-2" id="count-total">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <p class="text-gray-500 text-xs uppercase font-bold">System Status</p>
                <div class="flex items-center gap-2 mt-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="font-medium text-green-700">Operational</span>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Shop Details</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Seller ID (Smart)</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="seller-table-body" class="divide-y divide-gray-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_wy4_pxxwFkS63SSL_d5yug_Bgybs85R';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        lucide.createIcons();

        async function loadSellers() {
            const tbody = document.getElementById('seller-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Loading data...</td></tr>';

            // Fetch Sellers
            const { data, error } = await supabase
                .from('sellers')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                alert("Error: " + error.message);
                return;
            }

            // Update Stats
            const pendingCount = data.filter(s => !s.is_verified).length;
            document.getElementById('count-pending').innerText = pendingCount;
            document.getElementById('count-total').innerText = data.length;

            // Render Table
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">No sellers found.</td></tr>';
                return;
            }

            data.forEach(seller => {
                const isVerified = seller.is_verified;
                const numericId = seller.seller_numeric_id;
                
                // Status Badge Logic
                const statusBadge = isVerified 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending Approval</span>`;

                // Action Button Logic
                const actionButton = isVerified
                    ? `<button onclick="toggleStatus('${seller.id}', false)" class="text-red-600 hover:text-red-900 text-xs font-bold border border-red-200 px-3 py-1 rounded">Suspend</button>`
                    : `<button onclick="toggleStatus('${seller.id}', true)" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg hover:bg-indigo-700 text-xs font-bold shadow-sm transition">Verify & Approve</button>`;

                // ID Logic (Handle missing/corrupt IDs)
                let idDisplay = '';
                if (numericId) {
                    idDisplay = `<span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded text-gray-700 font-bold tracking-wide">${numericId}</span>`;
                } else {
                    // Show delete option for corrupted rows
                    idDisplay = `
                        <div class="text-xs text-red-500 font-bold mb-1">⚠️ Error Generating</div>
                        <button onclick="deleteSeller('${seller.id}')" class="text-[10px] underline text-red-600 hover:text-red-800">Delete Row</button>
                    `;
                }

                const row = `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-bold text-gray-900">${seller.shop_name || 'N/A'}</div>
                                    <div class="text-sm text-gray-500">${seller.full_name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${seller.email}</div>
                            <div class="text-xs text-gray-500">${seller.mobile_primary}</div>
                        </td>
                        <td class="px-6 py-4">
                            ${idDisplay}
                            <div class="text-[10px] text-gray-400 mt-1">Pin: ${seller.pincode}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 capitalize">${seller.business_type}</div>
                            <div class="text-xs text-gray-500">${seller.seller_entity_type || 'Individual'}</div>
                        </td>
                        <td class="px-6 py-4">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${actionButton}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function toggleStatus(uuid, newStatus) {
            const action = newStatus ? "APPROVE" : "SUSPEND";
            if (!confirm(`Are you sure you want to ${action} this seller?`)) return;

            // IMPORTANT: checking for data response to catch RLS errors
            const { data, error } = await supabase
                .from('sellers')
                .update({ is_verified: newStatus })
                .eq('id', uuid)
                .select();

            if (error) {
                alert("Database Error: " + error.message);
            } else if (data.length === 0) {
                // RLS Blocked the update (Return 0 rows updated)
                alert("❌ Permission Denied. \n\nYou cannot update this row because of RLS Security Policies.\nRun the 'Allow Public Update Access' SQL provided in the chat.");
            } else {
                // Success
                loadSellers();
            }
        }

        // Helper to clean up bad data
        async function deleteSeller(uuid) {
            if(!confirm("Delete this corrupted registration?")) return;
            const { error } = await supabase.from('sellers').delete().eq('id', uuid);
            if(error) alert(error.message);
            else loadSellers();
        }

        // Init
        loadSellers();
    </script>
</body>
</html>