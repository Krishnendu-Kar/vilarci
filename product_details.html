<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" xintegrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } 
        .rating_avg{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    font-size: 1rem;
    font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
    background-color:#038D63;
    color:rgb(246, 249, 246);
    padding: 2px 5px 2px 7px;
    border-radius: 8px;
}
.rating_count{
    font-size: .9rem;
    font-weight: 600;
    color:#999999;
}
    </style>
</head>
<body class="bg-slate-50 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="bg-indigo-600 text-white font-bold text-xl px-2 py-1 rounded">V</div>
                <h1 class="text-xl font-bold text-indigo-900">Vilarci</h1>
            </div>
            <a href="index.html" class="text-slate-500 hover:text-indigo-600 text-sm font-medium flex items-center gap-1">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Search
            </a>
        </div>
    </nav>

    <!-- LOADING STATE -->
    <div id="loader" class="flex flex-col items-center justify-center h-[80vh]">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-slate-500 text-sm animate-pulse">Loading product details...</p>
    </div>

    <!-- ERROR STATE -->
    <div id="error-screen" class="hidden flex flex-col items-center justify-center h-[80vh] text-center">
        <div class="bg-red-50 p-4 rounded-full mb-4">
            <i data-lucide="alert-circle" class="w-12 h-12 text-red-500"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-800">Product Not Found</h2>
        <p class="text-slate-500 mt-2 max-w-md">The product you are looking for might have been removed or the link is broken.</p>
        <a href="index.html" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">Go Home</a>
    </div>

    <!-- MAIN PRODUCT CONTAINER -->
    <main id="product-container" class="hidden max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
            
            <!-- LEFT: IMAGE GALLERY -->
            <div class="space-y-4">
                <div class="aspect-square bg-white rounded-2xl overflow-hidden border border-slate-200 shadow-sm relative group">
                    <span id="badge-label" class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full hidden shadow-sm z-10">
                        SALE
                    </span>
                    <img id="main-image" src="" class="w-full h-full object-contain p-8 hover:scale-105 transition-transform duration-500">
                </div>
                
                <!-- Thumbnails Container -->
                <div id="thumbnails" class="flex gap-2 overflow-x-auto pb-2 hidden">
                    <!-- JS will inject <img> tags here -->
                </div>
            </div>

            <!-- RIGHT: DETAILS -->
            <div class="space-y-6">
                
                <!-- Breadcrumbs & IDs -->
                <div class="flex justify-between items-start border-b border-slate-100 pb-4">
                    <div class="text-[10px] text-slate-400 font-mono space-y-1">
                        <p>Product ID: <span id="display-id" class="text-slate-600 font-bold select-all">...</span></p>
                        <p>Seller ID: <span id="display-seller" class="text-slate-600 select-all">...</span></p>
                    </div>
                </div>

                <!-- Title & Price -->
                <div>
                    <div class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-2" id="category-tag">Category</div>
                    <h1 id="product-title" class="text-2xl sm:text-3xl font-extrabold text-slate-900 leading-tight">...</h1>
                    
                    <div class="mt-4 flex items-baseline gap-3">
                        <span id="price-display" class="text-4xl font-bold text-slate-900">₹0</span>
                        <span id="mrp-display" class="text-lg text-slate-400 line-through decoration-2">₹0</span>
                        <span id="discount-display" class="text-sm font-bold text-green-600 bg-green-50 px-2 py-1 rounded"></span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">Inclusive of all taxes</p>
                </div>
                <div  class="rating_avg">
                    <span  id="rating_avg"></span> <i style="font-size:0.6em; margin-left:2px;" class="fa-solid fa-star"></i>
                </div>
                <span class="rating_count"></span>
               <!-- DYNAMIC LOGIC CONTAINER -->
                <div id="dynamic-logic-container" class="bg-white p-4 rounded-xl border-2 border-indigo-50 shadow-sm">
                    <!-- Injected via JS -->
                </div>

                <!-- DESCRIPTION -->
                <div>
                    <h3 class="font-bold text-slate-800 text-sm uppercase mb-2 flex items-center gap-2">
                         Description
                    </h3>
                    <p id="product-description" class="text-slate-600 text-sm leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-100">...</p>
                </div>

                <!-- HIGHLIGHTS -->
                <div id="highlights-section" class="hidden">
                    <h3 class="font-bold text-slate-800 text-sm uppercase mb-2">Key Highlights</h3>
                    <div id="product-highlights" class="grid grid-cols-1 gap-2 text-sm text-slate-600"></div>
                </div> 

                <!-- SPECIFICATIONS -->
                <div id="specs-section" class="hidden">
                    <h3 class="font-bold text-slate-800 text-sm uppercase mb-2">Specifications</h3>
                    <div id="specs-grid" class="grid grid-cols-2 gap-y-2 text-sm border-t border-slate-100 pt-3"></div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 md:static md:bg-transparent md:border-0 md:p-0 flex gap-3 z-40 shadow-lg md:shadow-none">
                    <button onclick="addToCart()" class="flex-1 bg-white border-2 border-indigo-600 text-indigo-700 font-bold py-3.5 rounded-xl hover:bg-indigo-50 transition flex justify-center items-center gap-2">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i> Add to Cart
                    </button>
                    <button class="flex-1 bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-indigo-700 transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                        <i data-lucide="zap" class="w-5 h-5"></i> Buy Now
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
    // ==========================================
    // 0. CONFIGURATION & SETUP
    // ==========================================
    const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dmNndWJicXRjY295Y3ZkdXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODA2MzQsImV4cCI6MjA4MDA1NjYzNH0.7Hobx-emspJQ7HLyjaWR-XQhzk948LWufq3OCimKk4w';
    
    // FIX 1: Renamed to 'supabaseClient' to avoid conflicts with window.supabase
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Initialize Icons
    lucide.createIcons();

    // Global State
    let currentProduct = {};
    let selectedPrice = 0;
    let selectedWeightLabel = "";

    // ==========================================
    // 1. MAIN INIT LOGIC
    // ==========================================
    async function initPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug'); 
        const idFallback = urlParams.get('id');

        // FIX 2: Using the renamed client
        let query = supabaseClient.from('products').select('*');

        if (slug) query = query.eq('slug', slug);
        else if (idFallback) query = query.eq('id', idFallback);
        else { showError(); return; }

        const { data, error } = await query.single();

        if (error || !data) {
            console.error("Error loading product:", error);
            showError();
            return;
        }

        currentProduct = data;
        renderUniversalData(data);
        
        // ID Decoding Logic
        const idString = data.id.toString();
        const fashionCode = idString.length >= 8 ? idString.substring(6, 8) : "00"; 
        const subAreaCode = idString.length >= 11 ? idString.substring(8, 11) : "000"; 

        console.log(`Product Loaded: ${data.name} | Type Code: ${fashionCode}`);

        // Logic Router
        if (fashionCode === '12') {
            renderFashionInterface(data);
        } else if (subAreaCode === '185') {
            renderWeightableInterface(data);
        } else {
            renderPacketInterface(data);
        }

        // Hide Loader
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('product-container').classList.remove('hidden');
        
        // Update Cart Count on Load
        updateGlobalCartCount();
    }

    // ==========================================
    // 2. RENDERERS
    // ==========================================
    function renderUniversalData(product) {
        // Ratings
        document.getElementById('rating_avg').innerText = product.rating_avg || 0;
        document.querySelector('.rating_count').innerText = product.rating_count > 0 
            ? `${product.rating_count} Ratings` : 'No Ratings';

        // IDs
        document.getElementById('display-id').innerText = product.id;
        
        // FIX 3: Optimized Seller Link (Uses local data first, fetch only if missing)
        const sellerLink = document.getElementById('display-seller');
        sellerLink.innerText = product.seller_id;
        
        if (product.shop_slug) {
            activateSellerLink(sellerLink, product.shop_slug);
        } else {
            // Fallback only if database missing column data
            fetchSellerSlugFallback(product.seller_id, sellerLink);
        }

        // Text Data
        document.getElementById('product-title').innerText = product.name;
        document.getElementById('product-description').innerText = product.description || "No description available.";
        
        // Category Tag
        if(document.getElementById('category-tag')) {
            // Mapping ID to text is complex without joining, placeholder for now
            document.getElementById('category-tag').innerText = "Vilarci Verified"; 
        }

        // --- Image Gallery ---
        const mainImg = document.getElementById('main-image');
        const thumbContainer = document.getElementById('thumbnails');
        thumbContainer.innerHTML = ''; 

        if (product.images && product.images.length > 0) {
            mainImg.src = product.images[0];

            if (product.images.length > 1) {
                thumbContainer.classList.remove('hidden');
                product.images.forEach((imgUrl, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = imgUrl;
                    thumb.className = `w-16 h-16 object-cover rounded-lg border-2 cursor-pointer transition ${index === 0 ? 'border-indigo-600' : 'border-transparent hover:border-indigo-300'}`;
                    
                    thumb.onmouseover = () => {
                        mainImg.src = imgUrl;
                        // Reset borders
                        Array.from(thumbContainer.children).forEach(t => {
                            t.classList.remove('border-indigo-600');
                            t.classList.add('border-transparent');
                        });
                        thumb.classList.remove('border-transparent');
                        thumb.classList.add('border-indigo-600');
                    };
                    thumbContainer.appendChild(thumb);
                });
            } else {
                thumbContainer.classList.add('hidden');
            }
        } else {
            mainImg.src = "https://via.placeholder.com/400?text=No+Image";
            thumbContainer.classList.add('hidden');
        }

        // Badge
        if (product.badge_label) {
            const badge = document.getElementById('badge-label');
            badge.innerText = product.badge_label;
            badge.classList.remove('hidden');
        }

        // Highlights
        if (product.highlights && product.highlights.length > 0) {
            document.getElementById('highlights-section').classList.remove('hidden');
            const div = document.getElementById('product-highlights');
            div.innerHTML = ''; 
            product.highlights.forEach(h => {
                div.innerHTML += `<div class="flex gap-2 items-start"><i data-lucide="check-circle2" class="w-4 h-4 text-green-500 mt-0.5"></i> <span>${h}</span></div>`;
            });
        }

        // Specifications
        if (product.specifications) {
            document.getElementById('specs-section').classList.remove('hidden');
            const grid = document.getElementById('specs-grid');
            grid.innerHTML = ''; 
            
            function parseSpecs(obj) {
                Object.entries(obj).forEach(([k, v]) => {
                    if(typeof v === 'object' && v !== null) parseSpecs(v);
                    else {
                        grid.innerHTML += `
                            <div class="text-slate-500 font-medium">${k}</div>
                            <div class="text-slate-800">${v}</div>
                        `;
                    }
                });
            }
            parseSpecs(product.specifications);
        }
        
        // Re-run icons for injected content
        lucide.createIcons();
    }

    // --- Helper for Seller Link ---
    function activateSellerLink(element, slug) {
        element.style.cursor = 'pointer';
        element.style.color = '#4f46e5';
        element.style.textDecoration = 'underline';
        element.onclick = () => window.location.href = `shop_profile.html?slug=${slug}`;
    }

    async function fetchSellerSlugFallback(numericId, element) {
        const { data, error } = await supabaseClient
            .from('shops_public_587')
            .select('shop_slug')
            .eq('seller_numeric_id', numericId.toString())
            .single();
        
        if (!error && data?.shop_slug) {
            activateSellerLink(element, data.shop_slug);
        }
    }


    // ==========================================
    // 3. INTERFACES (Weight, Packet, Fashion)
    // ==========================================

    // --- A. WEIGHTABLE ---
    function renderWeightableInterface(product) {
        const container = document.getElementById('dynamic-logic-container');
        const bulkRules = product.bulk_rules || [];

        let html = `
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold text-slate-800 text-sm uppercase">Select Quantity</h3>
                    <span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded">Bulk Savings</span>
                </div>
                <div class="grid grid-cols-1 gap-2" id="bulk-options-container">`;

        bulkRules.forEach((rule, index) => {
            const basePricePerGram = product.base_price / 1000; 
            let calcPrice = (rule.unit === 'gm' ? rule.min_qty : rule.min_qty * 1000) * basePricePerGram;
            
            let quantityLabel = rule.min_qty < 1000 && rule.unit === 'gm' ? `${rule.min_qty} gm` : `${rule.min_qty/1000} kg`;
            if(rule.unit !== 'gm' && rule.unit !== 'kg') quantityLabel = `${rule.min_qty} ${rule.unit}`;

            const finalPrice = Math.round(calcPrice - (rule.discount_amount || 0));
            const saved = Math.round(rule.discount_amount || 0);

            if(index === 0) {
                updatePriceUI(finalPrice, Math.round(calcPrice));
                selectedWeightLabel = quantityLabel;
            }

            html += `
                <div onclick="selectWeight(this, ${finalPrice}, ${Math.round(calcPrice)}, '${quantityLabel}')" 
                     class="weight-option cursor-pointer border rounded-xl p-3 flex justify-between items-center hover:border-indigo-500 transition-all ${index === 0 ? 'border-indigo-600 bg-indigo-50 ring-1 ring-indigo-600' : 'border-slate-200 bg-white'}">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${index === 0 ? 'border-indigo-600' : 'border-slate-300'}">
                            ${index === 0 ? '<div class="w-2.5 h-2.5 bg-indigo-600 rounded-full"></div>' : ''}
                        </div>
                        <div>
                            <p class="font-bold text-slate-800">${quantityLabel}</p>
                            ${saved > 0 ? `<p class="text-[10px] text-green-600 font-bold">Save ₹${saved}</p>` : ''}
                        </div>
                    </div>
                    <p class="font-bold text-slate-900">₹${finalPrice}</p>
                </div>`;
        });

        html += `</div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mt-2">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-1">
                        <i data-lucide="calculator" class="w-3 h-3"></i> Custom Amount
                    </h4>
                    <div class="flex items-center gap-3">
                        <div class="relative flex-1">
                            <input type="number" id="custom-weight" placeholder="0" 
                                class="w-full pl-3 pr-8 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                oninput="calculateCustom('weight', this.value)">
                            <span class="absolute right-3 top-2 text-xs font-bold text-slate-400">gm</span>
                        </div>
                        <i data-lucide="arrow-left-right" class="w-4 h-4 text-slate-300"></i>
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-2 text-xs font-bold text-slate-400">₹</span>
                            <input type="number" id="custom-cost" placeholder="0" 
                                class="w-full pl-6 pr-3 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                oninput="calculateCustom('cost', this.value)">
                        </div>
                    </div>
                </div>
            </div>`;

        container.innerHTML = html;
        lucide.createIcons();
    }

    // --- B. FASHION ---
    function renderFashionInterface(product) {
        const container = document.getElementById('dynamic-logic-container');
        const variants = product.variants || []; 

        let html = `
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-sm uppercase">Select Size</h3>
                    <a href="#" class="text-xs text-indigo-600 font-bold hover:underline">Size Chart</a>
                </div>
                <div class="grid grid-cols-4 gap-3">`;

        if(variants.length === 0) {
            html += `<p class="text-sm text-slate-500 col-span-4">No variants available.</p>`;
        } else {
            variants.forEach(v => {
                const isOutOfStock = v.stock <= 0;
                const baseClass = "cursor-pointer border rounded-lg py-3 flex flex-col items-center justify-center transition-all relative overflow-hidden group";
                const stockClass = isOutOfStock 
                    ? "bg-slate-50 border-slate-200 opacity-50 cursor-not-allowed" 
                    : "bg-white border-slate-200 hover:border-indigo-500 hover:shadow-sm";
                
                const clickAction = isOutOfStock ? "" : `selectFashionVariant(this, '${v.size}', ${v.price}, '${v.sku}')`;

                html += `
                    <div onclick="${clickAction}" class="variant-option ${baseClass} ${stockClass}">
                        <span class="font-bold text-slate-800 text-sm">${v.size}</span>
                        ${!isOutOfStock && v.stock < 10 ? `<span class="text-[9px] text-red-500 font-bold mt-1">${v.stock} left</span>` : ''}
                        ${isOutOfStock ? `<div class="absolute inset-0 flex items-center justify-center"><div class="w-full h-[1px] bg-slate-400 -rotate-45"></div></div>` : ''}
                    </div>`;
            });
        }

        html += `</div>
                <div id="fashion-warning" class="hidden text-xs text-red-500 font-bold flex items-center gap-1">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i> Please select a size
                </div>
            </div>`;

        container.innerHTML = html;
        selectedWeightLabel = ""; 
        selectedPrice = product.base_price; 
        lucide.createIcons();
    }

    // --- C. PACKET ---
    function renderPacketInterface(product) {
        const container = document.getElementById('dynamic-logic-container');
        
        let stockStatus = product.stock_quantity > 10 
            ? `<span class="text-green-600 font-bold flex items-center gap-1"><i data-lucide="check" class="w-4 h-4"></i> In Stock</span>`
            : `<span class="text-orange-600 font-bold">Only ${product.stock_quantity} left!</span>`;
        
        if(product.stock_quantity <= 0) stockStatus = `<span class="text-red-600 font-bold">Out of Stock</span>`;

        container.innerHTML = `
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <span class="text-sm font-medium text-slate-600">Availability</span>
                    ${stockStatus}
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-800">Quantity</span>
                    <div class="flex items-center border border-slate-300 rounded-lg bg-white">
                        <button onclick="updatePacketQty(-1)" class="px-3 py-2 text-slate-500 hover:bg-slate-100 transition">-</button>
                        <input type="text" id="packet-qty" value="1" class="w-10 text-center text-sm font-bold outline-none" readonly>
                        <button onclick="updatePacketQty(1)" class="px-3 py-2 text-slate-500 hover:bg-slate-100 transition">+</button>
                    </div>
                </div>
            </div>`;
        
        selectedWeightLabel = product.amount || "1 Unit"; 
        updatePriceUI(product.base_price, product.original_price);
        lucide.createIcons();
    }

    // ==========================================
    // 4. INTERACTION LOGIC
    // ==========================================

    window.selectWeight = function(element, price, mrp, label) {
        // Reset Custom Inputs
        document.getElementById('custom-weight').value = '';
        document.getElementById('custom-cost').value = '';

        // Reset Styles
        document.querySelectorAll('.weight-option').forEach(el => {
            el.className = 'weight-option cursor-pointer border border-slate-200 bg-white rounded-xl p-3 flex justify-between items-center hover:border-indigo-500 transition-all';
            el.querySelector('.w-5').className = 'w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center';
            el.querySelector('.w-5').innerHTML = '';
        });

        // Set Active Style
        element.className = 'weight-option cursor-pointer border border-indigo-600 bg-indigo-50 rounded-xl p-3 flex justify-between items-center ring-1 ring-indigo-600 transition-all';
        element.querySelector('.w-5').className = 'w-5 h-5 rounded-full border-2 border-indigo-600 flex items-center justify-center';
        element.querySelector('.w-5').innerHTML = '<div class="w-2.5 h-2.5 bg-indigo-600 rounded-full"></div>';

        selectedWeightLabel = label;
        updatePriceUI(price, mrp);
    }

    window.calculateCustom = function(mode, value) {
        // Deselect bulk options visual
        document.querySelectorAll('.weight-option').forEach(el => {
            el.className = 'weight-option cursor-pointer border border-slate-200 bg-white rounded-xl p-3 flex justify-between items-center hover:border-indigo-500 transition-all opacity-50';
            el.querySelector('.w-5').innerHTML = '';
        });

        const val = parseFloat(value);
        if (!val || val <= 0) {
            if(mode === 'weight') document.getElementById('custom-cost').value = '';
            if(mode === 'cost') document.getElementById('custom-weight').value = '';
            return;
        }

        const pricePerGram = currentProduct.base_price / 1000;

        if (mode === 'weight') {
            const cost = Math.round(val * pricePerGram);
            document.getElementById('custom-cost').value = cost;
            selectedPrice = cost;
            selectedWeightLabel = `${val} gm (Custom)`;
        } else {
            const weight = Math.round(val / pricePerGram);
            document.getElementById('custom-weight').value = weight;
            selectedPrice = Math.round(val);
            selectedWeightLabel = `${weight} gm (Custom)`;
        }

        updatePriceUI(selectedPrice, 0); 
    }

    window.selectFashionVariant = function(element, size, price, sku) {
        // Reset others
        document.querySelectorAll('.variant-option').forEach(el => {
            if(!el.classList.contains('opacity-50')) {
                el.className = "variant-option cursor-pointer border border-slate-200 bg-white rounded-lg py-3 flex flex-col items-center justify-center transition-all hover:border-indigo-500 relative overflow-hidden group";
            }
        });

        // Highlight Active
        element.className = "variant-option cursor-pointer border-2 border-indigo-600 bg-indigo-50 rounded-lg py-3 flex flex-col items-center justify-center transition-all relative overflow-hidden ring-1 ring-indigo-600";

        selectedPrice = price; 
        selectedWeightLabel = `Size: ${size}`; 
        
        updatePriceUI(selectedPrice, currentProduct.original_price);
        document.getElementById('fashion-warning').classList.add('hidden');
    }

    window.updatePacketQty = function(change) {
        const input = document.getElementById('packet-qty');
        let val = parseInt(input.value) + change;
        
        if(val < 1) val = 1;
        if(currentProduct.stock_quantity && val > currentProduct.stock_quantity) {
            Toastify({
                text: `Max stock is ${currentProduct.stock_quantity}`,
                duration: 2000,
                style: { background: "#ef4444" }
            }).showToast();
            val = currentProduct.stock_quantity;
        }
        
        input.value = val;
        selectedWeightLabel = `${val} Units`;
        updatePriceUI(currentProduct.base_price * val, currentProduct.original_price * val);
    }

    function updatePriceUI(price, mrp) {
        selectedPrice = price; 
        document.getElementById('price-display').innerText = `₹${price}`;
        
        if (mrp && mrp > price) {
            document.getElementById('mrp-display').innerText = `₹${mrp}`;
            const discount = Math.round(((mrp - price) / mrp) * 100);
            document.getElementById('discount-display').innerText = `${discount}% OFF`;
            document.getElementById('discount-display').classList.remove('hidden');
            document.getElementById('mrp-display').classList.remove('hidden');
        } else {
            document.getElementById('mrp-display').classList.add('hidden');
            document.getElementById('discount-display').classList.add('hidden');
        }
    }

    // ==========================================
    // 5. CART & ACTIONS
    // ==========================================

    function addToCart(isBuyNow = false) {
        // Safety Check for Fashion
        const idString = currentProduct.id.toString();
        const fashionCode = idString.length >= 8 ? idString.substring(6, 8) : "";
        
        if (fashionCode === '12' && (!selectedWeightLabel || selectedWeightLabel === "")) {
            document.getElementById('fashion-warning').classList.remove('hidden');
            Toastify({
                text: "Please select a size",
                duration: 3000,
                style: { background: "#ef4444" }
            }).showToast();
            return;
        }

        // Unique Cart ID
        const uniqueKey = `${currentProduct.slug}-${selectedWeightLabel.replace(/\s+/g, '-')}`;

        const cartItem = {
            cartItemId: uniqueKey,
            id: currentProduct.id,
            slug: currentProduct.slug,
            name: currentProduct.name,
            price: selectedPrice,
            originalPrice: currentProduct.original_price || selectedPrice,
            amount: selectedWeightLabel,
            image: (currentProduct.images && currentProduct.images.length > 0) ? currentProduct.images[0] : "",
            quantity: 1
        };

        let cart = JSON.parse(localStorage.getItem('cart') || "[]");
        const existingIndex = cart.findIndex(i => i.cartItemId === uniqueKey);

        if (existingIndex > -1) {
            cart[existingIndex].quantity += 1; 
        } else {
            cart.push(cartItem); 
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        updateGlobalCartCount();

        if (isBuyNow) {
            window.location.href = 'cart.html';
        } else {
            Toastify({
                text: "Added to Cart!",
                duration: 3000,
                gravity: "bottom", 
                position: "center", 
                style: {
                    background: "#22c55e", 
                    borderRadius: "8px",
                }
            }).showToast();
        }
    }

    // FIX 4: Implemented Buy Now Button Logic
    // Attach this to your Buy Now button in HTML: onclick="buyNow()"
    function buyNow() {
        addToCart(true);
    }
    
    // Attach to HTML Button
    document.querySelector('button .fa-zap, button .lucide-zap').closest('button').onclick = buyNow;

    function updateGlobalCartCount() {
        // Tries to update badge if it exists in the navbar
        let cart = JSON.parse(localStorage.getItem('cart') || "[]");
        let count = cart.reduce((acc, item) => acc + item.quantity, 0);
        
        // Try standard ID or class
        const badge = document.getElementById('cart-count-badge');
        if(badge) badge.innerText = count;
    }

    function showError() {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('error-screen').classList.remove('hidden');
    }

    // Start
    initPage();
</script>
</body>
</html>