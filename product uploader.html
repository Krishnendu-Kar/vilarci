<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Product Upload - Vilarci</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom scrollbar for JSON areas */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; }
        textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-8 px-4 font-sans text-slate-800">

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        
        <!-- Header -->
        <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">üì¶ Master Product Upload</h1>
                <p class="text-slate-400 text-xs mt-1">19-Digit ID Architecture ‚Ä¢ BigInt System</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-slate-400">Seller Mode</p>
                <!-- AUTO FILLED ID -->
                <p class="font-mono text-sm font-bold text-yellow-400" id="displaySellerId">Loading...</p>
            </div>
        </div>

        <form id="uploadForm" class="p-8 space-y-10">

            <!-- SECTION 1: SELLER & ID CONFIGURATION -->
            <section class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                <h3 class="text-blue-900 font-bold uppercase tracking-wider text-xs mb-4 flex items-center gap-2">
                    <span class="bg-blue-200 text-blue-800 py-1 px-2 rounded">Step 1</span> System Identification
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    
                    <!-- Auto-Generated Product ID -->
                    <div class="md:col-span-12">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            Generated Product ID (19 Digits)
                        </label>
                        <div class="relative">
                            <input type="text" id="final_product_id" readonly value="SELECT CATEGORIES FIRST"
                                class="w-full p-3 bg-slate-800 text-green-400 font-mono text-lg tracking-widest rounded-lg border border-slate-700">
                            <div class="absolute top-2 right-2 flex gap-1">
                                <button type="button" onclick="generateRandomSuffix()" class="text-xs bg-slate-700 text-white px-2 py-1 rounded hover:bg-slate-600">
                                    üîÑ New Code
                                </button>
                            </div>
                        </div>
                        <!-- ID Breakdown Visualization -->
                        <div class="flex gap-1 mt-2 text-[10px] text-slate-500 font-mono overflow-x-auto">
                            <div class="flex flex-col items-center"><span class="bg-white px-1 border">State(2)</span><span id="p_state">10</span></div>
                            <div class="flex flex-col items-center"><span class="bg-white px-1 border">Area(3)</span><span id="p_area">100</span></div>
                            <div class="flex flex-col items-center"><span class="bg-white px-1 border">Fix(1)</span><span>1</span></div>
                            <div class="flex flex-col items-center"><span class="bg-yellow-100 px-1 border border-yellow-200 text-yellow-700">Cat(2)</span><span id="p_cat">--</span></div>
                            <div class="flex flex-col items-center"><span class="bg-yellow-100 px-1 border border-yellow-200 text-yellow-700">Sub(3)</span><span id="p_sub">---</span></div>
                            <div class="flex flex-col items-center"><span class="bg-yellow-100 px-1 border border-yellow-200 text-yellow-700">Super(3)</span><span id="p_super">---</span></div>
                            <div class="flex flex-col items-center"><span class="bg-green-100 px-1 border border-green-200 text-green-700">Unique(5)</span><span id="p_unique">-----</span></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: CATEGORIZATION -->
            <section>
                <h3 class="text-slate-900 font-bold uppercase tracking-wider text-xs mb-4 border-b pb-2">Step 2: Categorization</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                        <select id="catSelect" onchange="handleCatChange()" class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sub Category</label>
                        <select id="subSelect" onchange="handleSubChange()" disabled class="w-full p-3 border rounded-lg bg-slate-50 disabled:text-slate-400">
                            <option value="">Select Category First</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Super Sub Category</label>
                        <select id="superSelect" onchange="handleSuperChange()" disabled class="w-full p-3 border rounded-lg bg-slate-50 disabled:text-slate-400">
                            <option value="">Select Sub Category First</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: PRODUCT DETAILS -->
            <section>
                <h3 class="text-slate-900 font-bold uppercase tracking-wider text-xs mb-4 border-b pb-2">Step 3: Basic Info</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Name & Slug -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Product Name</label>
                        <input type="text" id="name" oninput="generateSlug()" class="w-full p-3 border rounded-lg" placeholder="e.g. Urban Cotton Shirt">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Slug (Auto-Generated)</label>
                        <input type="text" id="slug" readonly class="w-full p-3 bg-slate-100 border rounded-lg text-slate-500">
                    </div>
                    
                    <!-- Pricing -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Base Price (‚Çπ)</label>
                            <input type="number" id="base_price" class="w-full p-3 border rounded-lg font-bold text-slate-800">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">MRP (‚Çπ)</label>
                            <input type="number" id="original_price" class="w-full p-3 border rounded-lg text-slate-500">
                        </div>
                    </div>

                    <!-- Stock & Badges -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Stock Quantity</label>
                            <input type="number" id="stock" value="0" class="w-full p-3 border rounded-lg">
                            <p class="text-[10px] text-orange-500 mt-1">*Set to 0 if using Variants</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Badge Label</label>
                            <input type="text" id="badge" placeholder="New Arrival" class="w-full p-3 border rounded-lg">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Description</label>
                        <textarea id="description" rows="3" class="w-full p-3 border rounded-lg"></textarea>
                    </div>

                    <!-- Image -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Image Link (Hostinger/External)</label>
                        <div class="flex gap-2">
                            <span class="bg-slate-100 border border-r-0 rounded-l-lg p-3 text-slate-500">üîó</span>
                            <input type="text" id="imageUrl" placeholder="https://hostinger.com/..." class="w-full p-3 border rounded-r-lg">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 4: ADVANCED JSON -->
            <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h3 class="text-slate-900 font-bold uppercase tracking-wider text-xs mb-4 flex items-center gap-2">
                    <span class="bg-slate-200 text-slate-800 py-1 px-2 rounded">Step 4</span> Advanced Configuration
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- VARIANTS -->
                    <div class="relative group">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold uppercase text-slate-500">Variants</label>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button type="button" onclick="setJson('variants', 'shirt')" class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded hover:bg-indigo-200">Shirt</button>
                                <button type="button" onclick="setJson('variants', 'chips')" class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded hover:bg-indigo-200">Chips</button>
                                <button type="button" onclick="setJson('variants', 'null')" class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded hover:bg-red-200">Clear</button>
                            </div>
                        </div>
                        <textarea id="variants" rows="8" class="w-full p-3 border rounded-lg font-mono text-xs bg-white text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">null</textarea>
                    </div>

                    <!-- SPECIFICATIONS -->
                    <div class="relative group">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold uppercase text-slate-500">Specifications</label>
                            <button type="button" onclick="setJson('specs', 'default')" class="opacity-0 group-hover:opacity-100 transition-opacity text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded hover:bg-indigo-200">Load Template</button>
                        </div>
                        <textarea id="specifications" rows="8" class="w-full p-3 border rounded-lg font-mono text-xs bg-white text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">{
  "General": {
    "Brand": "Generic"
  }
}</textarea>
                    </div>

                    <!-- BULK RULES -->
                    <div class="relative group">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold uppercase text-slate-500">Bulk Rules (Weight)</label>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button type="button" onclick="setJson('bulk', 'sugar')" class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded hover:bg-indigo-200">Sugar</button>
                                <button type="button" onclick="setJson('bulk', 'null')" class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded hover:bg-red-200">Clear</button>
                            </div>
                        </div>
                        <textarea id="bulk_rules" rows="8" class="w-full p-3 border rounded-lg font-mono text-xs bg-white text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none">null</textarea>
                    </div>

                </div>
            </section>

            <!-- SUBMIT -->
            <div class="pt-6 border-t border-slate-200">
                <button type="button" onclick="uploadProduct()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-1">
                    üöÄ Upload Product to Database
                </button>
            </div>

        </form>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://gxvcgubbqtccoycvdupq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_wy4_pxxwFkS63SSL_d5yug_Bgybs85R';
        
  
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ID Architecture Placeholders (To be replaced by Seller Auth later)
        const STATE_CODE = "10"; 
        const AREA_CODE = "100";
        const FIXED_VAL = "1";

        // DEMO DATA FOR TESTING
        const DEMO_CATEGORIES = [
            {
                id: "12", name: "Fashion", subs: [
                    { id: "101", name: "Men's Top Wear", supers: [
                        { id: "201", name: "T-Shirts" },
                        { id: "202", name: "Formal Shirts" }
                    ]},
                    { id: "102", name: "Women's Ethnic", supers: [
                        { id: "203", name: "Sarees" },
                        { id: "204", name: "Kurtas" }
                    ]}
                ]
            },
            {
                id: "14", name: "Grocery", subs: [
                    { id: "103", name: "Staples", supers: [
                        { id: "205", name: "Sugar & Jaggery" },
                        { id: "206", name: "Rice & Grains" }
                    ]},
                    { id: "104", name: "Snacks", supers: [
                        { id: "207", name: "Chips & Namkeen" },
                        { id: "208", name: "Biscuits" }
                    ]}
                ]
            }
        ];

        // ==========================================
        // 2. ID GENERATION LOGIC (The Core 19-digit logic)
        // ==========================================
        
        let currentUniqueCode = "00000";

        function generateRandomSuffix() {
            // Generate random 5 digit number (10000 to 99999)
            currentUniqueCode = Math.floor(10000 + Math.random() * 90000).toString();
            updateProductIdDisplay();
        }

        function pad(num, size) {
            let s = num + "";
            while (s.length < size) s = "0" + s;
            return s;
        }

        function updateProductIdDisplay() {
            // Get IDs from dropdowns
            const catId = document.getElementById('catSelect').value;
            const subId = document.getElementById('subSelect').value;
            const superId = document.getElementById('superSelect').value;

            // Logic: Only generate if ALL 3 are selected
            if (!catId || !subId || !superId) {
                document.getElementById('final_product_id').value = "INCOMPLETE SELECTION";
                document.getElementById('p_cat').innerText = catId ? pad(catId, 2) : "--";
                document.getElementById('p_sub').innerText = subId ? pad(subId, 3) : "---";
                document.getElementById('p_super').innerText = superId ? pad(superId, 3) : "---";
                document.getElementById('p_unique').innerText = "-----";
                return;
            }

            // Format parts
            const p_cat = pad(catId, 2);
            const p_sub = pad(subId, 3);
            const p_super = pad(superId, 3);

            // Update Breakdown UI
            document.getElementById('p_cat').innerText = p_cat;
            document.getElementById('p_sub').innerText = p_sub;
            document.getElementById('p_super').innerText = p_super;
            document.getElementById('p_unique').innerText = currentUniqueCode;

            // Construct Full ID String
            const fullId = `${STATE_CODE}${AREA_CODE}${FIXED_VAL}${p_cat}${p_sub}${p_super}${currentUniqueCode}`;
            document.getElementById('final_product_id').value = fullId;
        }


        // ==========================================
        // 3. DROPDOWN LOGIC (USING DEMO DATA)
        // ==========================================
        
        window.onload = function() {
            // Populate Category from DEMO_DATA
            const select = document.getElementById('catSelect');
            DEMO_CATEGORIES.forEach(c => select.add(new Option(c.name, c.id)));
            
            // Check for Logged In Seller
            const sellerId = sessionStorage.getItem('vilarci_seller_id');
            if(!sellerId) {
                // If not logged in, force login page
                window.location.href = 'login.html';
                return;
            }
            // Display Seller ID
            document.getElementById('displaySellerId').innerText = `ID: ${sellerId}`;
            
            generateRandomSuffix(); // Init logic
        };

        function handleCatChange() {
            const catId = document.getElementById('catSelect').value;
            const subSelect = document.getElementById('subSelect');
            const superSelect = document.getElementById('superSelect');
            
            // Reset downstream
            subSelect.innerHTML = '<option value="">Select Sub Category</option>';
            superSelect.innerHTML = '<option value="">Select Super Sub</option>';
            subSelect.disabled = true;
            superSelect.disabled = true;
            
            updateProductIdDisplay(); // Update ID to "Incomplete"

            if(!catId) return;

            // Find data in DEMO_DATA
            const category = DEMO_CATEGORIES.find(c => c.id === catId);
            if(category && category.subs) {
                subSelect.disabled = false;
                category.subs.forEach(s => subSelect.add(new Option(s.name, s.id)));
            }
        }

        function handleSubChange() {
            const catId = document.getElementById('catSelect').value;
            const subId = document.getElementById('subSelect').value;
            const superSelect = document.getElementById('superSelect');
            
            // Reset downstream
            superSelect.innerHTML = '<option value="">Select Super Sub</option>';
            superSelect.disabled = true;

            updateProductIdDisplay(); // Update ID to "Incomplete"

            if(!subId) return;

            // Find data in DEMO_DATA
            const category = DEMO_CATEGORIES.find(c => c.id === catId);
            const subCategory = category.subs.find(s => s.id === subId);
            
            if(subCategory && subCategory.supers) {
                superSelect.disabled = false;
                subCategory.supers.forEach(s => superSelect.add(new Option(s.name, s.id)));
            }
        }

        function handleSuperChange() {
            updateProductIdDisplay(); // Should trigger Final ID now
        }


        // ==========================================
        // 4. UTILITIES (Templates, Slug, Seller Display)
        // ==========================================

        function generateSlug() {
            const name = document.getElementById('name').value;
            const slug = name.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');
            document.getElementById('slug').value = slug + '-' + Math.floor(Math.random() * 1000);
        }

        function setJson(type, template) {
            const el = document.getElementById(type === 'specs' ? 'specifications' : (type === 'bulk' ? 'bulk_rules' : 'variants'));
            
            if(template === 'null') {
                el.value = 'null';
                return;
            }

            if(type === 'variants' && template === 'shirt') {
                el.value = JSON.stringify([
                    { "size": "M", "color": "Blue", "price": 499, "stock": 10, "sku": "SH-BLU-M" },
                    { "size": "L", "color": "Blue", "price": 499, "stock": 15, "sku": "SH-BLU-L" }
                ], null, 2);
            } else if (type === 'variants' && template === 'chips') {
                el.value = JSON.stringify([
                    { "flavor": "Masala", "weight": "50g", "price": 10, "stock": 100 },
                    { "flavor": "Cream Onion", "weight": "50g", "price": 10, "stock": 100 }
                ], null, 2);
            } else if (type === 'bulk' && template === 'sugar') {
                el.value = JSON.stringify([
                    { "min_qty": 500, "unit": "gm", "discount_amount": 1 },
                    { "min_qty": 1000, "unit": "gm", "discount_amount": 3 }
                ], null, 2);
            } else if (type === 'specs') {
                el.value = JSON.stringify({
                    "General": { "Brand": "BrandName", "Material": "Cotton" },
                    "Warranty": { "Summary": "No Warranty" }
                }, null, 2);
            }
        }

        // ==========================================
        // 5. UPLOAD LOGIC
        // ==========================================
        async function uploadProduct() {
            // 1. Get IDs (CRITICAL: Strings for BigInt)
            const generatedId = document.getElementById('final_product_id').value;
            
            // Get Seller ID from Session (Previously manual)
            const sellerId = sessionStorage.getItem('vilarci_seller_id');

            if(!sellerId) { 
                alert("‚ö†Ô∏è Session Expired. Please login again."); 
                window.location.href = 'login.html';
                return; 
            }
            if(generatedId.length !== 19 || isNaN(generatedId)) { alert("‚ö†Ô∏è Product ID incomplete. Please select all 3 category levels."); return; }

            // 2. Gather Data
            const form = {
                name: document.getElementById('name').value,
                slug: document.getElementById('slug').value,
                description: document.getElementById('description').value,
                badge: document.getElementById('badge').value,
                price: document.getElementById('base_price').value,
                mrp: document.getElementById('original_price').value,
                stock: document.getElementById('stock').value,
                imageUrl: document.getElementById('imageUrl').value,
                catId: document.getElementById('catSelect').value || null,
                subId: document.getElementById('subSelect').value || null,
                superId: document.getElementById('superSelect').value || null
            };

            // 3. Parse JSON
            let specs, variants, bulk;
            try {
                specs = JSON.parse(document.getElementById('specifications').value);
                
                const varText = document.getElementById('variants').value;
                variants = (varText.trim() === 'null') ? null : JSON.parse(varText);
                
                const bulkText = document.getElementById('bulk_rules').value;
                bulk = (bulkText.trim() === 'null') ? null : JSON.parse(bulkText);
            } catch(e) {
                alert("‚ùå JSON Syntax Error. Please check your brackets!");
                return;
            }

            // 4. Construct Payload
            // Note: 'id' and 'seller_id' are sent as strings. Supabase/Postgres handles the BigInt conversion.
            const payload = {
                id: generatedId, 
                seller_id: sellerId,
                name: form.name,
                slug: form.slug,
                description: form.description,
                badge_label: form.badge,
                base_price: form.price,
                original_price: form.mrp ? form.mrp : null,
                stock_quantity: form.stock,
                images: [form.imageUrl],
                category_id: form.catId,
                sub_category_id: form.subId,
                super_sub_id: form.superId,
                specifications: specs,
                variants: variants,
                bulk_rules: bulk,
                is_active: true
            };

            // 5. Send
            const { data, error } = await supabase.from('products').insert([payload]);

            if(error) {
                console.error(error);
                alert("Upload Failed: " + error.message);
            } else {
                alert(`‚úÖ Product ${generatedId} Uploaded Successfully!`);
                location.reload();
            }
        }
    </script>
</body>
</html>